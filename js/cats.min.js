function abacus(){function e(e){u=e.on("click",function(){i()}),c=u.select("ul"),o()}function t(e){var t=d3.layout.hierarchy().value(function(e){return e.depth*e.values?e.values.length:e.children?e.children.length:1}).sort(function(e,t){return d3.descending(e.values.length,t.values.length)||d3.ascending(e.key,t.key)});u.datum(t({children:e.result}).map(function(e){return e.fork=!1,e})),p=!1,c.datum(u.datum()[0].children).call(n,1)}function n(e,t){var n=e.selectAll("li").data(identity,s);if(n.enter().append("li").each(r),n.each(a),n.exit().filter(function(e){return!p||e.depth===t}).each(l),n.order(),p){var i=n.filter(function(e){return e.fork});n.classed("soften",!!i.size()),i.classed("soften",!1)}else n.classed("soften",!1)}function r(e){var t=d3.select(this).attr("class","level").classed("legend-row",!0).classed(" legend-row--new",!0).on("click",i),n=t.append("div").attr("class",function(e){return"legend-item row "+(e.children?e.fork?"branch--opened":"branch--closed":"branch--leaf")}).classed("legend-item",!0).classed("row",!0),r=n.append("div").attr("class","col-xs-5 legend-bar-container").attr("role","presentation").attr("pointer-events","all").attr("data-balloon-pos","up").attr("data-balloon-length","small");r.append("div").attr("class",function(e){return slugify(e.key)}).classed("legend-bar",!0).style("width","0%"),r.filter(function(e){return~["Confirmation","Body"].indexOf(e.level)}).each(function(e){d3.select(this).select(".legend-bar").classed(slugify(e.values[0].value.Category),!0)});var a=n.append("div").attr("class","col-xs-7 legend-label-container").attr("pointer-events","all").attr("data-balloon",function(e){var t=d[e.key]||d[e.parent.key]||d[e.parent.parent.key];return t?t.Summary:""}).attr("data-balloon-pos","left").attr("data-balloon-length","large");a.append("span").attr("class","legend-label--text").attr("pointer-events","all").style("margin-left",function(e){return+e.depth-1+.25+"em"}),r.style("height",a.style("height")),t.append("ul").attr("class","kids legend")}function a(e){var t=d3.select(this);e.fork&&e.children&&t.select("ul").datum(e.children).call(n,e.depth),e.children||t.select("ul").datum([]).call(n,e.depth+1),t.select(".legend-item").attr("class",function(){return e.children?e.fork?"branch--opened":"branch--closed":"branch--leaf"}).classed("legend-item",!0).classed("row",!0),t.transition().duration(duration).each("end",function(){d3.select(this).classed("legend-row--new",!1)}),t.select(".legend-label--text").text(function(){return" "+e.key+" ("+e.values.length+")"});var r=t.select(".legend-bar-container").attr("data-balloon",function(e){var t=e.values.map(function(e){var t=e.values?e.values[0]:e.value;return t.State});return t.length+" state"+(t.length>1?"s":"")+": "+t.join(", ")}).attr("data-balloon-pos","right").attr("data-balloon-length","large");r.select(".legend-bar").style("width",function(e){return h(e.values.length)+"%"}).filter(function(e){return~["Confirmation","Body"].indexOf(e.level)}).each(function(e){var t=d3.select(this),n="Confirmation"===e.level?e:e.parent;t.classed(slugify(n.key),!0)})}function l(e){d3.select(this).transition().duration(500).each("start",function(e){e.children&&d3.select(this).select("ul").datum([]).call(n,e.depth),d3.select(this).classed("legend-row--remove",!0)}).each("end",function(){d3.select(this).remove()})}function s(e){return[e.key,e.depth,e.parent&&e.parent.depth?e.parent.key:null]}function i(e){d3.event.stopPropagation();var t=c.datum(),r=1;if(arguments.length){var a=!e.fork;e.parent.children.forEach(function(e){e.fork=!1}),e.fork=a;var l=e.fork?e:e.parent,s=l.children||[];s.forEach(function(e){e.fork=!1}),t=[l].concat(s).filter(function(e){return e.depth}),p=!0,r=e.depth+1}else c.datum().forEach(function(e){e.fork=!1}),p=!1;c.call(n,r),f.hilite({result:t,hilite:p})}function o(){u.style("height",d3.select("#atlas").style("height"))}var u,c,d,f,p,h=d3.scale.linear().domain([0,51]).rangeRound([0,100]);return e.connect=function(n){return arguments.length&&(f=n.on("display.legend",t)),e},e.reference=function(t){return arguments.length?(d=t,e):d},e.resize=function(){o()},e}function askus(){function e(e){r=e,o.all=r.select(".choice-all"),o.pick=r.select(".choice-pick"),l=o.pick.select("select"),a=r.attr("id").split("-")[1],t()}function t(){o.all.on("click",function(){i="all",r.select(".choice-pick select").selectAll("option").property("selected",function(e,t){return!t}),s({key:a,value:i})}),o.pick.on("click",function(){var e=d3.select(this).select("input").node().value;l.node().value||(l.selectAll("option:enabled").property("selected",function(t,n){return e?t.key===e:1===n}),l.each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}))})}function n(e){e.unshift({key:"",value:l.select("optgroup").node().label}),l.on("change",function(){i=this.value,d3.select(this.parentNode).select("input").node().value=i,s({key:a,value:i})}),l.selectAll("option").data(e,identikey).enter().append("option").text(identival).attr("value",identikey).attr("hidden",function(e,t){return t?null:"hidden"})}var r,a,l,s,i,o={all:null,pick:null};return e.callback=function(t){return arguments.length?(s=t,e):s},e.choices=function(t){return arguments.length?(n(t),e):l.selectAll("option").data()},e.reset=function(){return o.all.node().click(),e},e.value=function(t){return arguments.length?("all"!==t&&""!==t||o.all.node().click(),""===t||(l.selectAll("option").property("selected",function(e,n){return~e.key.indexOf(t)||!n}),l.node().value?(l.each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}),o.pick.node().click()):o.all.node().click()),e):i},e}function atlas(){function e(e){u=e.datum(t).select("svg").attr("viewBox","0 0 "+p+" "+h).call(k),~browser.indexOf("ie")&&u.attr("preserveAspectRatio","xMidYMin slice").style({width:"100%",height:"1px",overflow:"visible"}).style("padding-bottom",100*h/p+"%"),u.attr("role","img").attr("aria-labelledby","title").append("title").attr("id","title").text("Map of the USA"),u.attr("aria-describedby","desc").append("desc").attr("id","desc").text("An interactive map of the United States. Each state changes color to reflect its category or process."),u.append("defs"),u.append("g").attr("id","visual").attr("transform","translate("+v.top+","+v.left+")"),n(),i()}function t(e){return topojson.feature(e,e.objects.states).features.map(function(e){y.push({key:e.properties.usps,value:e.properties.name});var t=f.centroid(e);if(!t.some(isNaN)){t.x=t[0],t.y=t[1],t.feature=e;var n=f.bounds(t.feature);return t.feature.properties.bounds={dx:n[1][0]-n[0][0],dy:n[1][1]-n[0][1],x:(n[0][0]+n[1][0])/2,y:(n[0][1]+n[1][1])/2},t}}).filter(identity)}function n(){var e=u.select("#visual");e.append("rect").attr("class","click-target").attr({x:0,y:0,width:"100%",height:"100%"}).on("click",function(){d.value("all")}),e.append("g").attr("id","states").selectAll(".state").data(identity).enter().append("g").attr("class",function(e){return e.feature.properties.usps+" state"}).append("path").attr("d",function(e){return f(e.feature)}).attr("pointer-events","all").attr("cursor","pointer").on("click",function(e){var t=e.feature.properties.usps;d.value(t===d.value()?"all":t)}).on("mouseover",function(e){k.html(e.feature.properties.name).show()}).on("mouseout",k.hide),u.select("defs").append("g").attr("id","stamps").selectAll("path").data(identity).enter().append("path").attr("id",function(e){return e.feature.properties.usps}).attr("d",function(e){return f(e.feature)}),u.select("defs").append("g").attr("id","patterns").selectAll("pattern").data(["Legislative Confirmation","Other Confirmation"],identity).enter().append("pattern").attr("id",function(e){return"pattern_"+slugify(e)}).attr("patternUnits","userSpaceOnUse").attr("patternTransform",function(e,t){return"rotate("+(90*t+10)+" 0 0)"}).attr({width:10,height:10}).append("rect").attr({width:4,height:10}).attr("transform","translate(0,0)").attr("class","confirmation"),o=y.map(identikey)}function r(e){var t=e.result.map(function(e){return e.values.map(identikey)}).reduce(flatten),n=_.difference(o,t),r=u.select("#states");a(e),r.selectAll(".state").classed("soften",!1),n.length&&r.selectAll(n.map(function(e){return"."+e}).join(",")).classed("soften",!0).select("path").attr("class","not_applicable")}function a(e){e.result.forEach(function(e){if("Confirmation"===e.key)return void e.children.forEach(function(t){var r=slugify(t.key+" "+e.key);n=t.values.map(function(e){return"."+e.key}).join(","),u.select("#states").selectAll(n).each(function(e){d3.select(this).select(".overlay").size()||d3.select(this).append("use").attr("xlink:href","#"+e.feature.properties.usps).attr("class","overlay").style("fill","url(#pattern_"+r+")")})});var t=slugify(e.key),n=e.values.map(function(e){return"."+e.key}).join(","),r="Confirmation"===e.level||"Body"===e.level;u.select("#states").selectAll(n).select("path").attr("class",r?"blank":t),r&&u.selectAll(".overlay").style("stroke","darkgray")});var t=e.result.filter(function(e){return"Confirmation"===e.key||"Confirmation"===e.level||"Body"===e.level});t.length||u.selectAll(".overlay").transition().duration(duration).each("start",function(){d3.select(this).classed("soften",!0)}).each("end",function(){d3.select(this).remove()})}function l(e){var t=u.select("#states"),n=e.result[0];if(a(e),t.selectAll(".state").classed("soften",e.hilite?n.fork:!1),e.hilite){var r=n.values.map(function(e){return"."+e.key}).join(",");t.selectAll(r).classed("soften",!1),t.selectAll(r).select(".overlay").classed("soften",!1)}t.selectAll(".not_applicable").classed("soften",!0),1===e.result.length&&1===n.values.length?d.value(n.values[0].key):d.value("all")}function s(){var e=d.value()||"";u.select("#states").selectAll(".state").transition().each("start",function(t){t.feature.properties.usps===e&&(this.parentNode.parentNode.appendChild(this.parentNode),this.parentNode.appendChild(this))}).each("end",function(t){d3.select(this).classed("clicked",t.feature.properties.usps===e)})}function i(){~browser.indexOf("ie")&&u.style("width","100%")}var o,u,c,d,f=d3.geo.path().projection(null),p=960,h=600,v={top:10,left:20,right:20,bottom:10},y=[],k=d3.tip().attr("class","d3-tip");return e.connect=function(t){return arguments.length&&(c=t.on("display.atlas",r).on("hilite.atlas",l).on("state.atlas",s)),e},e.control=function(t){return arguments.length?(d=t.choices(y.sort(function(e,t){return d3.ascending(e.value,t.value)})),e):d},e.resize=function(){i()},e}function corpus(){function e(e){s=e.datum(n),r(),o.Court=s.select("#chooser-Court .btn"),o.Phase=askus(),o.State=askus(),t()}function t(){o.Court.select("select").on("change",function(){d3.select(this.parentNode).select("input").node().value=this.value,a({key:"Court",value:this.value})}),o.Court.select("select").selectAll("option").data(d.Court).enter().append("option").text(identival).attr("value",identikey),s.select("#chooser-Phase").call(o.Phase),o.Phase.choices(d.Phase).callback(a),d3.select("#chooser-State").call(o.State.callback(a)),o.reset=s.select(".reset-button button").on("click",function(){o.Court.select("select").selectAll("option").property("selected",function(e,t){return!t}),o.Court.select("select").each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}),o.Court.node().click(),o.Phase.reset(),o.State.reset()})}function n(e){function t(e){var t;return t="string"==typeof e?e:d3.entries(e).filter(function(e){return"Yes"===e.value}).map(function(e){return e.key.trim()})[0],t||"Not Applicable"}function n(e){var t=[];return d3.entries(e).filter(function(e){return"Yes"===e.value["Yes/No"]}).forEach(function(e){~e.key.toLowerCase().indexOf("confirmation")&&t.push(s(e)),~e.key.toLowerCase().indexOf("elections")&&r(e).forEach(function(e){t.push(e)}),~e.key.toLowerCase().indexOf("appointment")&&t.push(a(e)),~e.key.toLowerCase().indexOf("nominat")&&t.push(l(e))}),t}function r(e){return e.value.Type.split(",").map(function(t){return{step:"Process",Process:e.key,Type:t.trim()+" "+e.key}})}function a(e){return{step:"Process",Process:e.key}}function l(e){return{step:"Nomination",Process:e.key,Type:e.value.Type}}function s(e){var t=e.value.Legislative?"Legislative":"Other";return{step:"Confirmation",Process:"Confirmation",Type:t,Body:e.value[t]}}var i=[];return e.forEach(function(e){d3.entries(e.Phases).forEach(function(r){if("Overview"===r.key)return void i.push({State:e.State,USPS:e.Abbrev,Court:e.Court,Overview:t(r.value.Category),Description:r.value["Text Box"]||null});var a=n(r.value.Process);a.forEach(function(n){i.push({State:e.State,USPS:e.Abbrev,Court:e.Court,Phase:r.key,Category:t(r.value.Category),step:n.step,Process:n.Process,Type:n.Type||null,Body:n.Body||null})})})}),i}function r(){function e(e){return e.values=e.value.map(function(e){return e.value=e.values.pop(),e.values=null,e}),e.value=null,e}function t(e){return d3.entries(e).map(function(e){return e.value=e.value[0],e})}function n(e){return e.value=e.values,e}function r(e){var n={key:e.key,children:[],values:null};return d3.entries(e.value).forEach(function(r){return r.key===e.key?(n.values=t(r.value),r):void("Commission Reappoints"!==e.key&&n.children.push(a(r)))}),n}function a(e){switch(e.key){case"Nominating Commission":e.children=d3.entries(e.value).map(function(e){return e.values=t(e.value),e.value=null,e.level="Commission",e}),e.values=d3.values(e.value).map(t).reduce(flatten);break;case"Confirmation":e.values=d3.values(e.value).map(function(e){return d3.values(e).map(t).reduce(flatten)}).reduce(flatten),e.children=d3.entries(e.value).map(function(e){return e.values=d3.values(e.value).map(t).reduce(flatten),e.children=d3.entries(e.value).map(function(e){return e.values=t(e.value),e.value=null,e.level="Body",e}),e.value=null,e.level="Confirmation",e});break;default:e.values=t(e.value),e.children=null}return e.value=null,e.level="Process",e}var l=s.datum().filter(function(e){return e.Overview}),i=s.datum().filter(function(e){return e.Phase}),o={Court:d3.nest().key(function(e){return e.Court}).key(function(e){return e.Overview}).rollup(function(e){return d3.nest().key(function(e){return e.USPS}).entries(e)}).map(l),Phase:d3.nest().key(function(e){return e.Court}).key(function(e){return e.Phase}).key(function(e){return e.Category}).rollup(function(e){return d3.nest().key(function(e){return e.USPS}).entries(e)}).map(i),Process:d3.nest().key(function(e){return e.Court}).key(function(e){return e.Phase}).key(function(e){return e.Category}).key(function(e){return"Elections"===e.Process?e.Type:e.Process}).rollup(function(e){var t=e.filter(function(e){return"Process"!==e.step}),n=d3.nest();return t.length?(n.key(function(e){return e.Type}),t.some(function(e){return e.Body})&&n.key(function(e){return e.Body})):t=null,n.key(function(e){return e.USPS}).map(t||e)}).map(i)};c={Court:{},Phase:{}},d={Court:[],Phase:[]},d3.map(o.Court).forEach(function(t,a){var l=t.split(" ");l.pop();var s=l.pop();d.Court.push({key:s,value:t}),c.Court[s]=d3.entries(a).map(e),c.Phase[s]={},d3.map(o.Process[t]).forEach(function(e,a){var l=e.split(" ")[0];d.Phase.push({key:l,value:e}),c.Phase[s][l]=d3.entries(a).map(r).map(function(r){return r.values=r.values||o.Phase[t][e][r.key].map(n),r})})}),d.Phase=d3.nest().key(identikey).rollup(function(e){return e[0]}).entries(d.Phase).map(function(e){return e.values})}function a(e){return u[e.key]=e.value,"State"===e.key?(i.state(u),void l(u)):(u.result="all"===u.Phase?c.Court[u.Court]:u.result=c.Phase[u.Court][u.Phase],void(u.result&&(i.display(u),l(u))))}function l(e){var t=[];t.push("court="+e.Court),"all"!==e.Phase&&t.push("phase="+e.Phase),"all"!==e.State&&t.push("state="+e.State),history.pushState(null,null,"?"+t.join("&"))}var s,i,o={},u={},c={},d={};return e.data=function(){return s.datum()},e.counts=function(){return c},e.connect=function(t){return arguments.length&&(i=t),e},e.atlas=function(e){return arguments.length?void(o.State=e):o.State},e.start=function(t){t.court||t.phase||o.reset.node().click();var n;return t.court&&(n=o.Court.select("select"),n.selectAll("option").property("selected",function(e,n){return~e.key.toLowerCase().indexOf(t.court)||!n}),n.each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}),o.Court.node().click()),o.Phase.value(_.capitalize(t.phase)),o.State.value(t.state?t.state.toUpperCase():"all"),e},e.query=function(t){return a(t),e},e}function oculus(){function e(e){s=e,i=s.select("#focus"),t(),s.datum(l)}function t(){var e=a(s.datum()),t=s.select("#locus").selectAll("div").data(e,identikey).enter().append("div").attr("class","phase col-md-4 col-xs-12");t.append("h5").html(identikey).attr("data-balloon",function(e){return u[e.key].Summary}).attr("data-balloon-pos","up").attr("data-balloon-length","medium"),t=t.append("ul").attr("class","list-unstyled"),t.selectAll("li").data(function(e){return e.values.sort(function(e,t){return d3.ascending(e.key.split(" ").pop(),t.key.split(" ").pop())}).sort(function(e,t){return"Nominating Commission"===t.key})},identikey).enter().append("li").attr("class","process").attr("data-balloon",function(e){return u[e.key].Summary}).attr("data-balloon-pos","left").attr("data-balloon-length","large").append("span").html(identikey)}function n(e){c=e.State&&"all"!==e.State?s.datum()[e.State][e.Court]:null,i.html(c?c.description:d);var t=s.select("#locus").selectAll("div").data(c?c.values:[],identikey);t.each(function(e){var t=d3.select(this).selectAll("li").data(e.values,identikey);t.attr("class",function(e){return slugify("Elections"===e.key?e.values[0].Type:e.key)}).classed("process",!0),t.select("span").classed("hilite",!0).html(function(e){if(e.values.length>1)return e.values.map(function(e){return e.Type.split(" ")[0]}).join(", ")+" "+e.values[0].Process;var t=u[e.values[0].Body||e.values[0].Type||e.values[0].Process];return t?t.Title:e.values[0].Type||e.values[0].Process}),t.exit().attr("class","process").select("span").classed("hilite",!1).html(identikey)}),t.exit().each(function(){d3.select(this).selectAll("li").attr("class","process").select("span").classed("hilite",!1).html(identikey)})}function r(e){var t=null;if(e.hilite&&!c){var n=e.result[0],t=u[n.key]||u[n.parent.key]||u[n.parent.parent.key];t&&(t=t.Description)}d=t}function a(e){return d3.nest().key(function(e){return e.Phase}).key(function(e){return e.Process}).rollup(function(e){return d3.nest().key(function(e){return e.USPS}).entries(e)}).entries(e.filter(function(e){return e.Phase})).map(function(e){return e.values.sort(function(e,t){return d3.ascending(e.key,t.key)}),e})}function l(e){return d3.nest().key(function(e){return e.USPS}).key(function(e){var t=e.Court.split(" ");return t.pop(),t.pop()}).rollup(function(e){var t=d3.nest().key(function(e){return e.Phase}).key(function(e){return e.Process}).entries(e.filter(function(e){return e.Process})),n=e.filter(function(e){return!e.Process})[0];return{description:n.Description,overview:n.Overview,values:t}}).map(e)}var s,i,o,u,c,d=null;return e.connect=function(t){return arguments.length?(o=t.on("state.oculus",n).on("hilite.oculus",r).on("display.oculus",n),e):o},e.reference=function(t){return arguments.length?(u=t,e):u},e}function identity(e){return e}function identikey(e){return e.key}function identival(e){return e.value}function identivals(e){return e.values}function identistate(e){return e.State}function flatten(e,t){return e.concat(t)}function sum(e,t){return e+t}function slugify(e){return e.toLowerCase().split("&").join("and").split("'").join().split(":").join().split(" ").join("_").split("/").join("_")}function getQueryVariables(){var e,t={},n=window.location.search.substring(1).toLowerCase().split("&");return n.forEach(function(n){e=n.split("="),e[0].length&&e[1].length&&(t[e[0]]=decodeURIComponent(e[1]))}),t}function ingest(e){function t(e,t){return e.map(function(e){return e[t]}).forEach(function(e,t){if(e){for(var n=t;n<l.length;++n)l[n]=null;l[t]=e}else e=l[t]}),l.filter(identity)}var n,r=d3.csv.parseRows(e),a=[],l=[];do n=r.shift(),a.push(n);while(!n[0]);return r.map(function(e){var n={};return l=[],e.forEach(function(e,r){"string"==typeof e&&(e=e.trim()),_.set(n,t(a,r),e)}),n})}function get_browser(e){return~e.indexOf("Edge")?"edge":~e.indexOf("Trident")?"ienew":~e.indexOf("MSIE")?"ie":~e.indexOf("Firefox")?"firefox":e}var margin={top:20,right:10,bottom:20,left:10},width=960-margin.left-margin.right,height=375-margin.top-margin.bottom,duration=500,files={bcj:"data/brennan.csv",info:"data/reference.csv",geo:"data/usa.json"},signal=d3.dispatch("display","hilite","state"),reference,results={},browser=get_browser(navigator.userAgent);d3_queue.queue().defer(d3.text,files.bcj).defer(d3.csv,files.info).defer(d3.json,files.geo).await(function(e,t,n,r){if(e)throw e;var a=ingest(t),l={corpus:corpus(),abacus:abacus(),oculus:oculus(),atlas:atlas()};reference=d3.nest().key(function(e){return e.Term}).rollup(function(e){return e[0]}).map(n),d3.select("#corpus").datum(a).call(l.corpus),d3.select("#atlas").datum(r).call(l.atlas).select("svg"),d3.select("#abacus").datum(l.corpus.counts()).call(l.abacus.reference(reference)),d3.select("#oculus").datum(l.corpus.data()).call(l.oculus.reference(reference)),d3.map(l).forEach(function(e,t){t.connect(signal)}),l.atlas.control(l.corpus.atlas());var s=[];d3.selectAll(".btn").each(function(){s.push(d3.select(this).style("height"))}),"ienew"!==browser&&d3.selectAll(".btn").style("height",function(){return d3.max(s)}),l.corpus.start(getQueryVariables()),window.onpopstate=function(e){l.corpus.start(getQueryVariables())},window.onresize=function(e){l.atlas.resize(),l.abacus.resize()}});