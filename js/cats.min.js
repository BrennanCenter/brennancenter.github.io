function identity(e){return e}function identikey(e){return e.key}function identival(e){return e.value}function identivals(e){return e.values}function identistate(e){return e.State}function flatten(e,t){return e.concat(t)}function sum(e,t){return e+t}function slugify(e){return e.toLowerCase().split("&").join("and").split("'").join().split(":").join().split(" ").join("_")}function getRule(e){for(var t,n=window.document.styleSheets,r=n.length,a=0;r>a;a++){var l=n[a].rules||n[a].cssRules;if(l){var s=d3.entries(l).filter(function(t){return t.value.selectorText===e});s.length&&(t=s[0])}}return t}function getQueryVariables(){var e,t={},n=window.location.search.substring(1).toLowerCase().split("&");return n.forEach(function(n){e=n.split("="),e[0].length&&e[1].length&&(t[e[0]]=decodeURIComponent(e[1]))}),t}function ingest(e){function t(e,t){return e.map(function(e){return e[t]}).forEach(function(e,t){if(e){for(var n=t;n<l.length;++n)l[n]=null;l[t]=e}else e=l[t]}),l.filter(identity)}var n,r=d3.csv.parseRows(e),a=[],l=[];do n=r.shift(),a.push(n);while(!n[0]);return r.map(function(e){var n={};return l=[],e.forEach(function(e,r){"string"==typeof e&&(e=e.trim()),_.set(n,t(a,r),e)}),n})}function askus(){function e(e){r=e,u.all=r.select(".choice-all"),u.pick=r.select(".choice-pick"),l=u.pick.select("select"),a=r.attr("id").split("-")[1],t()}function t(){u.all.on("click",function(){i="all",r.select(".choice-pick select").selectAll("option").property("selected",function(e,t){return!t}),s({key:a,value:i})}),u.pick.on("click",function(){var e=d3.select(this).select("input").node().value;l.node().value||(l.selectAll("option:enabled").property("selected",function(t,n){return e?t.key===e:1===n}),l.each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}))})}function n(e){e.unshift({key:"",value:l.select("optgroup").node().label}),l.on("change",function(){i=this.value,d3.select(this.parentNode).select("input").node().value=i,s({key:a,value:i})}),l.selectAll("option").data(e,identikey).enter().append("option").text(identival).attr("value",identikey).attr("hidden",function(e,t){return t?null:"hidden"})}var r,a,l,s,i,u={all:null,pick:null};return e.callback=function(t){return arguments.length?(s=t,e):s},e.choices=function(t){return arguments.length?(n(t),e):l.selectAll("option").data()},e.reset=function(){return u.all.node().click(),e},e.value=function(t){return arguments.length?("all"===t?u.all.node().click():(l.selectAll("option").property("selected",function(e,n){return~e.key.toLowerCase().indexOf(t)||!n}),l.node().value?(l.each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}),u.pick.node().click()):u.all.node().click()),e):i},e}function tellus(){function e(e){n=e.classed("hidden",!0).style("position","absolute")}function t(e){var t=d3.event,r=t.clientX,a=t.clientY,l=window.pageYOffset,s=e.getBoundingClientRect();n.style("top",a+l-s.height-18+"px").style("left",Math.min(Math.max(0,r-s.width/2),window.innerWidth-s.width)+"px")}var n;return e.hide=function(){n.classed("hidden",!0)},e.show=function(e,r){n.html(r).classed("hidden",!1),t(e)},e}function corpus(){function e(e){s=e.datum(n),r(),u.Court=s.select("#chooser-Court .btn"),u.Phase=askus(),u.State=askus(),t(),console.log(s.datum(),c)}function t(){u.Court.select("select").on("change",function(){d3.select(this.parentNode).select("input").node().value=this.value,a({key:"Court",value:this.value})}),u.Court.select("select").selectAll("option").data(d.Court).enter().append("option").text(identival).attr("value",identikey),s.select("#chooser-Phase").call(u.Phase),u.Phase.choices(d.Phase).callback(a),d3.select("#chooser-State").call(u.State.callback(a)),u.reset=s.select("#reset-all").on("click",function(){u.Court.select("select").selectAll("option").property("selected",function(e,t){return!t}),u.Court.select("select").each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}),u.Court.node().click(),u.Phase.reset(),u.State.reset()})}function n(e){function t(e){var t;return t="string"==typeof e?e:d3.entries(e).filter(function(e){return"Yes"===e.value}).map(function(e){return e.key.trim()})[0],t||"Not Applicable"}function n(e){var t=[];return d3.entries(e).filter(function(e){return"Yes"===e.value["Yes/No"]}).forEach(function(e){~e.key.toLowerCase().indexOf("confirmation")&&t.push(s(e)),~e.key.toLowerCase().indexOf("elections")&&r(e).forEach(function(e){t.push(e)}),~e.key.toLowerCase().indexOf("appointment")&&t.push(a(e)),~e.key.toLowerCase().indexOf("nominat")&&t.push(l(e))}),t}function r(e){return e.value.Type.split(",").map(function(t){return{step:"Process",Process:e.key,Type:t.trim()+" "+e.key}})}function a(e){return{step:"Process",Process:e.key}}function l(e){return{step:"Nomination",Process:e.key,Type:e.value.Type}}function s(e){var t=e.value.Legislative?"Legislative":"Other";return{step:"Confirmation",Process:"Confirmation",Type:t,Body:e.value[t]}}var i=[];return e.forEach(function(e){d3.entries(e.Phases).forEach(function(r){if("Overview"===r.key)return void i.push({State:e.State,USPS:e.Abbrev,Court:e.Court,Overview:t(r.value.Category),Description:r.value["Text Box"]||null});var a=n(r.value.Process);a.forEach(function(n){i.push({State:e.State,USPS:e.Abbrev,Court:e.Court,Phase:r.key,Category:t(r.value.Category),step:n.step,Process:n.Process,Type:n.Type||null,Body:n.Body||null})})})}),i}function r(){function e(e){return e.values=e.value.map(function(e){return e.value=e.values.pop(),e.values=null,e}),e.value=null,e}function t(e){return d3.entries(e).map(function(e){return e.value=e.value[0],e})}function n(e){return e.value=e.values,e}function r(e){var n={key:e.key,children:[],values:null};return d3.entries(e.value).forEach(function(r){return r.key===e.key?(n.values=t(r.value),r):void("Commission Reappoints"!==e.key&&n.children.push(a(r)))}),n}function a(e){switch(e.key){case"Nominating Commission":e.children=d3.entries(e.value).map(function(e){return e.values=t(e.value),e.value=null,e.level="Commission",e}),e.values=d3.values(e.value).map(t).reduce(flatten);break;case"Confirmation":e.values=d3.values(e.value).map(function(e){return d3.values(e).map(t).reduce(flatten)}).reduce(flatten),e.children=d3.entries(e.value).map(function(e){return e.values=d3.values(e.value).map(t).reduce(flatten),e.children=d3.entries(e.value).map(function(e){return e.values=t(e.value),e.value=null,e.level="Body",e}),e.value=null,e.level="Confirmation",e});break;default:e.values=t(e.value),e.children=null}return e.value=null,e.level="Process",e}var l=s.datum().filter(function(e){return e.Overview}),i=s.datum().filter(function(e){return e.Phase}),u={Court:d3.nest().key(function(e){return e.Court}).key(function(e){return e.Overview}).rollup(function(e){return d3.nest().key(function(e){return e.USPS}).entries(e)}).map(l),Phase:d3.nest().key(function(e){return e.Court}).key(function(e){return e.Phase}).key(function(e){return e.Category}).rollup(function(e){return d3.nest().key(function(e){return e.USPS}).entries(e)}).map(i),Process:d3.nest().key(function(e){return e.Court}).key(function(e){return e.Phase}).key(function(e){return e.Category}).key(function(e){return"Elections"===e.Process?e.Type:e.Process}).rollup(function(e){var t=e.filter(function(e){return"Process"!==e.step}),n=d3.nest();return t.length?(n.key(function(e){return e.Type}),t.some(function(e){return e.Body})&&n.key(function(e){return e.Body})):t=null,n.key(function(e){return e.USPS}).map(t||e)}).map(i)};c={Court:{},Phase:{}},d={Court:[],Phase:[]},d3.map(u.Court).forEach(function(t,a){var l=t.split(" ");l.pop();var s=l.pop();d.Court.push({key:s,value:t}),c.Court[s]=d3.entries(a).map(e),c.Phase[s]={},d3.map(u.Process[t]).forEach(function(e,a){var l=e.split(" ")[0];d.Phase.push({key:l,value:e}),c.Phase[s][l]=d3.entries(a).map(r).map(function(r){return r.values=r.values||u.Phase[t][e][r.key].map(n),r})})}),d.Phase=d3.nest().key(identikey).rollup(function(e){return e[0]}).entries(d.Phase).map(function(e){return e.values})}function a(e){return o[e.key]=e.value,"State"===e.key?(i.state(o),void l(o)):(o.result="all"===o.Phase?c.Court[o.Court]:o.result=c.Phase[o.Court][o.Phase],void(o.result&&(i.display(o),l(o))))}function l(e){var t=[];t.push("court="+e.Court),"all"!==e.Phase&&t.push("phase="+e.Phase),"all"!==e.State&&t.push("state="+e.State),history.pushState(null,null,"?"+t.join("&"))}var s,i,u={},o={},c={},d={};return e.data=function(){return s.datum()},e.counts=function(){return c},e.connect=function(t){return arguments.length&&(i=t),e},e.atlas=function(e){return arguments.length?void(u.State=e):u.State},e.start=function(t){t.court||t.phase||u.reset.node().click();var n;return t.court&&(n=u.Court.select("select"),n.selectAll("option").property("selected",function(e,n){return~e.key.toLowerCase().indexOf(t.court)||!n}),n.each(function(e,t){d3.select(this).on("change").apply(this,[e,t])}),u.Court.node().click()),u.Phase.value(t.phase),u.State.value(t.state?t.state.toLowerCase():"all"),e},e.query=function(t){return a(t),e},e}function atlas(){function e(e){d3.select("#tooltip").call(h),l=e.select("svg").attr("viewBox","0 0 "+c+" "+d).append("g").attr("id","states").attr("transform","translate("+f.top+","+f.left+")"),s=e.select("svg").append("defs"),n()}function t(e){return topojson.feature(e,e.objects.states).features.map(function(e){var t=o.centroid(e);if(!t.some(isNaN))return t.x=t[0],t.y=t[1],t.feature=e,p.push({key:e.properties.usps,value:e.id}),t}).filter(identity)}function n(){s.append("g").attr("id","shapes").selectAll("path").data(t).enter().append("path").attr("id",function(e){return slugify(e.feature.properties.usps)}).attr("d",function(e){return o(e.feature)}).style("all","inherit"),s.append("g").attr("id","#patterns").selectAll("pattern").data(["Legislative Confirmation","Other Confirmation"],identity).enter().append("pattern").attr("id",function(e){return"pattern_"+slugify(e)}).attr("patternUnits","userSpaceOnUse").attr("patternTransform",function(e,t){return"rotate("+(90*t+10)+" 0 0)"}).attr({width:10,height:10}).append("rect").attr({width:3,height:10}).attr("transform","translate(0,0)").attr("class","confirmation"),l.append("rect").attr("class","click-target").attr({x:0,y:0,width:"100%",height:"100%"}).on("click",function(){u.value("all")}),l.selectAll(".state").data(p,identikey).enter().append("use").attr("xlink:href",function(e){return"#"+slugify(e.key)}).attr("class","state not_applicable").attr("pointer-events","all").attr("cursor","pointer").on("click",function(e){u.value(e.key===u.value()?"all":slugify(e.key))}).on("mouseover",function(e){h.show(this,e.value)}).on("mouseout",function(){h.hide()}),l.selectAll(".state").classed("soften",!0)}function r(e){var t=l.selectAll("g").data(e.result,identikey);t.enter().append("g"),t.exit().selectAll("use").classed("transparent",!0),t.each(function(e){this.parentNode.appendChild(this);var t=d3.select(this),n=slugify(e.key),r="Confirmation"===e.level?e:"Body"===e.level?e.parent:!1;t.attr("class",n);var a=t.selectAll("use."+n).data(e.values,identikey);a.enter().append("use").attr("xlink:href",function(e){return"#"+slugify(e.key)}).attr("class",function(e){return slugify(e.key)+" "+n}).classed("transparent",!0).style("fill",function(){return r?"url(#pattern_"+slugify(r.key+" "+r.level)+")":null}).attr("pointer-events","none"),a.each(function(e){r&&(l.selectAll("."+slugify(e.key)+"."+slugify(e.value.Category)).classed("transparent",!1),l.selectAll("."+slugify(e.key)+"."+slugify(r.parent.key)).classed("transparent",!0)),d3.select(this).classed("transparent",!1)}),a.exit().classed("transparent",!0)}),1===e.result.length&&1===e.result[0].values.length&&u.value(slugify(e.result[0].values[0].key)),a()}function a(){var e=u.value()||"";l.selectAll("use").transition().each("start",function(t){t.key===e&&(this.parentNode.parentNode.appendChild(this.parentNode),this.parentNode.appendChild(this))}).each("end",function(t){d3.select(this).classed("clicked",t.key===e)})}var l,s,i,u,o=d3.geo.path().projection(null),c=960,d=600,f={top:10,left:20,right:20,bottom:10},p=[],h=tellus();return e.connect=function(t){return arguments.length&&(i=t.on("display.atlas",r).on("hilite.atlas",r).on("state.atlas",a)),e},e.control=function(t){return arguments.length?(u=t.choices(p.sort(function(e,t){return d3.ascending(e.value,t.value)})),e):u},e.icon=function(e,t){if(arguments.length){var n=e.node().parentNode.parentNode.clientWidth,r=e.node().parentNode.parentNode.clientHeight,a="#"+slugify(t);d3.select(e.node().parentNode).attr({width:n,height:r}),s.selectAll("path"+a).each(function(t){var l=o.bounds(t.feature),s=l[1][0]-l[0][0],i=l[1][1]-l[0][1],u=(l[0][0]+l[1][0])/2,f=(l[0][1]+l[1][1])/2,p=.9/Math.max(s/c,i/d),h=[c/2-p*u,d/2-p*f],v=Math.min(n/c,r/d);e.select("use").remove(),e.attr("transform","scale("+v+")").append("use").attr("xlink:href",a).attr("transform","translate("+h+")scale("+p+")")})}},e}function abacus(){function e(e){d3.select("#tooltip").call(p),i=e,t()}function t(){u=i.select("ul")}function n(e){var t=d3.layout.hierarchy().value(function(e){return e.depth*e.values?e.values.length:e.children?e.children.length:1}).sort(function(e,t){return d3.descending(e.values.length,t.values.length)||d3.ascending(e.key,t.key)});i.datum(t({children:e.result}).map(function(e){return e.fork=!1,e})),u.datum(i.datum()[0].children),u.selectAll("li").data(identity,l).call(r),i.on("click",function(){s()})}function r(e){var t=e.enter().append("li").classed("legend-row",!0).classed(" legend-row--new",!0),n=t.append("div").attr("class",function(e){return e.children?e.fork?"branch--opened":"branch--closed":"branch--leaf"}).classed("legend-item",!0),r=n.append("div").attr("class","legend-bar-container"),a=n.append("div").attr("class","legend-label-container"),l=a.append("span").attr("class","legend-label--text").attr("pointer-events","all").on("click",s).style("margin-left",function(e){return+e.depth-1+.5+"em"});t.append("ul").attr("class","kids legend"),a.attr("pointer-events","all").on("click",s).on("mouseover",function(e){p.show(this,c[e.key]?c[e.key].Summary:c[e.parent.key]?c[e.parent.key].Summary:c[e.parent.parent.key]?c[e.parent.parent.key].Summary:"")}).on("mouseout",p.hide),l.append("text"),r.attr("pointer-events","all").on("click",s).on("mouseout",p.hide).append("div").attr("class",function(e){return slugify(e.key)}).classed("legend-bar",!0).style("height","auto").style("width","0%"),r.filter(function(e){return~["Confirmation","Body"].indexOf(e.level)}).each(function(e){d3.select(this).select(".legend-bar").classed(slugify(e.values[0].value.Category),!0)}),e.select(".legend-item").attr("class",function(e){return e.children?e.fork?"branch--opened":"branch--closed":"branch--leaf"}).classed("legend-item",!0),e.transition().duration(500).each("end",function(){d3.select(this).classed("legend-row--new",!1)});var i=e.select(".legend-bar-container").on("mouseover",function(e){p.show(this,e.values.map(function(e){var t=e.values?e.values[0]:e.value;return t.State}).join("<br>"))});i.select(".legend-bar").style("width",function(e){return f(e.values.length)+"%"}).filter(function(e){return~["Confirmation","Body"].indexOf(e.level)}).each(function(e){var t="Confirmation"===e.level?e:e.parent,n=d3.select(this),r=getRule("."+slugify(e.values[0].value.Category)).value.style.fill;n.style("background","repeating-linear-gradient("+("Legislative"===t.key?"110":"10")+"deg,"+stripe+","+stripe+" 3px, rgba(255,255,255,0) 3px, rgba(255,255,255,0) 10px)").style("background-color",r)});var u=e.select(".legend-label-container .legend-label--text");u.select("text").text(function(e){return" "+e.key+" ("+e.values.length+")"}),u.select("i").attr("class",function(e){return"fa fa-"+(e.children?e.fork?"minus-":"plus-":"")+"square-o"}).classed("transparent",function(e){return!e.children}),e.classed("soften",!1).order(),e.exit().transition().duration(duration).each("start",function(){d3.select(this).classed("legend-row--remove",!0)}).each("end",function(){d3.select(this).remove()})}function a(e){var t=u.selectAll("li").data([e],l);t.each(function(t){var n=d3.select(this),a=n.select("ul").selectAll("li").data(t.fork?e.children||[]:[],l);r(a),a.order(),a.exit().transition().duration(duration).each("start",function(){d3.select(this).classed("legend-row--remove",!0)}).each("end",function(){d3.select(this).remove()}),n.classed("soften",!1)}),t.select(".legend-item").attr("class",function(e){return e.children?e.fork?"branch--opened":"branch--closed":"branch--leaf"}).classed("legend-item",!0),t.exit().filter(function(t){return t.depth>e.depth}).each(function(e){e.fork=!1}).remove(),t.exit().filter(function(t){return t.depth===e.depth}).each(function(t){t.fork=!1,d3.select(this).select(".legend-item").attr("class",function(e){return e.children?e.fork?"branch--opened":"branch--closed":"branch--leaf"}).classed("legend-item",!0),d3.select(this).classed("soften",e.fork)})}function l(e){return[e.key,e.depth,e.parent?e.parent.key:null]}function s(e){if(d3.event.stopPropagation(),arguments.length){e.fork=!e.fork,a(e);var t=e.fork?e:e.parent;d.hilite({result:(t.depth?[t]:[]).concat(t.children).filter(identity)})}else u.datum().forEach(function(e){e.fork=!1}),r(u.selectAll("li").data(identity,l)),d.hilite({result:u.datum()})}var i,u,o,c,d,f=(d3.scale.linear().domain([0,51]).rangeRound([0,o]),d3.scale.linear().domain([0,51]).rangeRound([0,100])),p=tellus();return e.connect=function(t){return arguments.length&&(d=t.on("display.legend",n)),e},e.reference=function(t){return arguments.length?(c=t,e):c},e}function oculus(){function e(e){d3.select("#tooltip").call(p),s=e,o=s.select("#focus").style("position","relative").append("div").attr("z-index",1).append("div"),i=o.append("svg").attr("z-index",-1).style("position","absolute").attr("top","0"),o=o.append("div").attr("class","details"),u=i.append("defs"),i=i.append("g").attr("class","state-icon"),t(),s.datum(l)}function t(){var e=a(s.datum()),t=s.select("#locus").selectAll("div").data(e,identikey).enter().append("div").attr("class","phase");t.append("h5").html(identikey).on("mouseover",function(e){p.show(this,f[e.key].Summary)}).on("mouseout",p.hide),t=t.append("ul").attr("class","list-unstyled"),t.selectAll("li").data(function(e){return e.values.sort(function(e,t){return d3.ascending(e.key.split(" ").pop(),t.key.split(" ").pop())}).sort(function(e,t){return"Nominating Commission"===t.key})},identikey).enter().append("li").attr("class","process").html(identikey).on("mouseover",function(e){p.show(this,f[e.key].Summary)}).on("mouseout",p.hide)}function n(e){var t;e.State&&"all"!==e.State&&(t=s.datum()[e.State][e.Court]),o.html(t?t.description:null);var n=s.select("#locus").selectAll("div").data(t?t.values:[],identikey);n.each(function(e){var t=d3.select(this).selectAll("li").data(e.values,identikey);t.attr("class",function(e){return slugify("Elections"===e.key?e.values[0].Type:e.key)}).classed("hilite",!0).classed("process",!0).html(function(e){if(e.values.length>1)return e.values.map(function(e){return e.Type.split(" ")[0]}).join(", ")+" "+e.values[0].Process;var t=f[e.values[0].Body||e.values[0].Type||e.values[0].Process];return t?t.Title:e.values[0].Type||e.values[0].Process}),t.exit().attr("class","process").html(identikey)}),n.exit().each(function(){d3.select(this).selectAll("li").attr("class","process").html(identikey)})}function r(e){var t=e.result.filter(function(e){return e.fork});if(t.length){n({});var r=f[t[0].key];o.html(r?r.Description:null)}}function a(e){return d3.nest().key(function(e){return e.Phase}).key(function(e){return e.Process}).rollup(function(e){return d3.nest().key(function(e){return e.USPS}).entries(e)}).entries(e.filter(function(e){return e.Phase})).map(function(e){return e.values.sort(function(e,t){return d3.ascending(e.key,t.key)}),e})}function l(e){return d3.nest().key(function(e){return e.USPS}).key(function(e){var t=e.Court.split(" ");return t.pop(),t.pop()}).rollup(function(e){var t=d3.nest().key(function(e){return e.Phase}).key(function(e){return e.Process}).entries(e.filter(function(e){return e.Process})),n=e.filter(function(e){return!e.Process})[0];return{description:n.Description,values:t}}).map(e)}var s,i,u,o,c,d,f,p=tellus();return e.connect=function(t){return arguments.length?(c=t.on("state.oculus",n).on("hilite.oculus",r).on("display.oculus",n),e):c},e.reference=function(t){return arguments.length?(f=t,e):f},e.get_icon=function(t){return arguments.length?(d=t,e):d},e}var margin={top:20,right:10,bottom:20,left:10},width=960-margin.left-margin.right,height=375-margin.top-margin.bottom,duration=300,files={bcj:"data/brennan.csv",info:"data/reference.csv",geo:"data/usa.json"},signal=d3.dispatch("display","hilite","state"),reference,results={},stripe=getRule(".confirmation").value.style.fill;queue().defer(d3.text,files.bcj).defer(d3.csv,files.info).defer(d3.json,files.geo).await(function(e,t,n,r){if(e)throw e;var a=ingest(t),l={corpus:corpus(),abacus:abacus(),oculus:oculus(),atlas:atlas()};reference=d3.nest().key(function(e){return e.Term}).rollup(function(e){return e[0]}).map(n),d3.select("#corpus").datum(a).call(l.corpus),d3.select("#atlas").datum(r).call(l.atlas).select("svg"),d3.select("#abacus").datum(l.corpus.counts()).call(l.abacus.reference(reference)),d3.select("#oculus").datum(l.corpus.data()).call(l.oculus.reference(reference)),d3.map(l).forEach(function(e,t){t.connect(signal)}),l.atlas.control(l.corpus.atlas()),l.oculus.get_icon(l.atlas.icon);var s=[];d3.selectAll(".btn").each(function(){s.push(d3.select(this).style("height"))}),d3.selectAll(".btn").style("height",function(){return d3.max(s)}),l.corpus.start(getQueryVariables()),window.onpopstate=function(e){l.corpus.start(getQueryVariables())}});